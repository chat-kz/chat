var contactList=document.getElementById("contactList"),contacts=document.getElementById("contacts"),textInputWindow=document.getElementById("textInputWindow"),chatContent=document.getElementById("chatContent"),msgText=document.getElementById("msgText"),userLogin=sessionStorage.getItem("userName"),textInputWindowText=document.getElementById("textInputWindowText"),lastOutMessageEl=null,lastOutMessageData=null,lastInMessageEl=null,lastInMessageData=null,msgCount=0,currentMessageReceiver,users=[],socket,scrollTopBeforeAppendMessage=0,myUnreadMessagesWhenCustomScroll=0,addContact=function(e){var t=document.createElement("LI");t.textContent=e,addListener(t,"click",loadChatWindow),contacts.appendChild(t)},removeContact=function(e){contacts.hasChildNodes()&&[].slice.call(contacts.children).forEach(function(t){t.childNodes[0]&&t.childNodes[0].data==e&&contacts.removeChild(t)})},clearContacts=function(){contacts.innerHTML=""},updateUsersList=function(){if(clearContacts(),users.length>0){users.sort(function(e,t){return e>t?1:t>e?-1:0});for(var e in users)addContact(users[e]);allMessagesFromContactIsRead("")}},appendMessage=function(e,t){if(msgCount++,scrollTopBeforeAppendMessage=chatContent.scrollHeight-chatContent.offsetHeight,t?(lastOutMessageEl=null,lastOutMessageData=null):(lastInMessageEl=null,lastInMessageData=null),t&&lastInMessageData&&e.messageDate==lastInMessageData.messageDate){var s=lastInMessageEl.getElementsByClassName("in")[0],n=s.getElementsByClassName("time")[0];s.removeChild(n),s.innerHTML+="<br/><span>"+e.fromUser+":"+escapeHTML(e.message)+'</span><span class="time">'+e.messageDate+"</span>"}else if(!t&&lastOutMessageData&&e.messageDate==lastOutMessageData.messageDate){var a=lastOutMessageEl.getElementsByClassName("out")[0],o=a.getElementsByClassName("time")[0];a.removeChild(o),a.innerHTML+="<br/><span>"+e.fromUser+":"+escapeHTML(e.message)+'</span><span class="time">'+e.messageDate+"</span>"}else{var r=document.createElement("DIV");r.id="msg_no"+msgCount,r.className=t?"message right":"message left";var c=t?"in":"out";r.innerHTML='<div class="'+c+'"><span>'+e.fromUser+":"+escapeHTML(e.message)+'</span><span class="time">'+e.messageDate+"</span></div>",chatContent.appendChild(r),t?lastInMessageEl=r:lastOutMessageEl=r}t?lastInMessageData=e:lastOutMessageData=e,scrollToBottom()},sendMsg=function(){if(""!=msgText.value){var e=new Date,t=("0"+e.getDate()).slice(-2)+"."+("0"+(e.getMonth()+1)).slice(-2)+"."+e.getFullYear()+" "+("0"+e.getHours()).slice(-2)+":"+("0"+e.getMinutes()).slice(-2),s={fromUser:userLogin,toUser:currentMessageReceiver,message:msgText.value,messageDate:t};appendMessage(s,!1),saveToHistory(currentMessageReceiver,s),socket.emit("chatEvent",s),msgText.value=""}},scrollToBottom=function(){var e=chatContent.scrollHeight-chatContent.offsetHeight;chatContent.scrollTop==scrollTopBeforeAppendMessage&&(chatContent.scrollTop=e)},keyPress=function(e){13==e.which&&(e.preventDefault(),sendMsg())},loadChatWindow=function(){currentMessageReceiver=event.currentTarget.childNodes[0].data,textInputWindowText.textContent=writeTo+currentMessageReceiver,chatContent.innerHTML="",scrollTopBeforeAppendMessage=0,myUnreadMessagesWhenCustomScroll=0,showChatWindow(),lastOutMessageData=null,lastOutMessageEl=null,lastInMessageData=null,lastInMessageEl=null,loadFromHistory(currentMessageReceiver),loadUnreadMessagesFromContact(currentMessageReceiver),allMessagesFromContactIsRead(currentMessageReceiver)},closeChatWindow=function(){textInputWindow.style.display="none"},showChatWindow=function(){textInputWindow.style.display=""},minimizeContactsWindow=function(){contactList.style.display="none"},maximizeContactsWindow=function(){contactList.style.display=""},toggleContactsWindow=function(){var e=event.currentTarget;"none"==contactList.style.display?(maximizeContactsWindow(),e.textContent=minimize):(minimizeContactsWindow(),e.textContent=expand)},addListener=function(e,t,s){e.addEventListener?e.addEventListener(t,s,!1):e.attachEvent?e.attachEvent("on"+t,s):e["on"+t]=s};closeChatWindow(),minimizeContactsWindow();var initSocket=function(e){socket=io.connect(cs61796),userLogin=e,socket.on("connect",function(){socket.emit("login",userLogin)}),socket.on("userAlreadyLoggedIn",function(){socket.disconnect()}),socket.on("newUserConnected",function(e){-1==users.indexOf(e)&&(users.push(e),updateUsersList())}),socket.on("userDisconnected",function(e){var t=users.indexOf(e);-1!=t&&(users.splice(t,1),updateUsersList())}),socket.on("chatEvent",function(e){var t=JSON.parse(e);processNewMessage(t)}),socket.on("contactList",function(e){users=e.split(","),updateUsersList()})},processNewMessage=function(e){if(e.fromUser==currentMessageReceiver&&"none"!=textInputWindow.style.display)appendMessage(e,!0),saveToHistory(currentMessageReceiver,e),chatContent.scrollTop!=chatContent.scrollHeight-chatContent.offsetHeight?(myUnreadMessagesWhenCustomScroll++,setUnreadMessageCountForContact(currentMessageReceiver,myUnreadMessagesWhenCustomScroll)):(myUnreadMessagesWhenCustomScroll=0,setUnreadMessageCountForContact(currentMessageReceiver,null));else{var t=sessionStorage.getItem("unreadMessages");t=t?JSON.parse(t):[],t.push(e),sessionStorage.setItem("unreadMessages",JSON.stringify(t)),updateUnreadMessagesAtContactList(t)}},loadUnreadMessagesFromContact=function(e){var t=sessionStorage.getItem("unreadMessages");if(t=t?JSON.parse(t):null)for(var s=0,n=t.length;n>s;s++)t[s].fromUser==e&&(appendMessage(t[s],!0),saveToHistory(currentMessageReceiver,t[s]))},allMessagesFromContactIsRead=function(e){var t=sessionStorage.getItem("unreadMessages");t=t?JSON.parse(t):null,t&&(t=t.filter(function(t){return t.fromUser!=e}),sessionStorage.setItem("unreadMessages",JSON.stringify(t)),updateUnreadMessagesAtContactList(t))},updateUnreadMessagesAtContactList=function(e){var t={};for(var s in users){for(var n=users[s],a=0,o=e.length;o>a;a++)if(n==e[a].fromUser)if(null!=t[n]){var r=t[n];r=1+r,t[n]=r}else t[n]=1;setUnreadMessageCountForContact(n,t[n])}},setUnreadMessageCountForContact=function(e,t){contacts.hasChildNodes()&&[].slice.call(contacts.children).forEach(function(s){s.childNodes[0]&&s.childNodes[0].data==e&&(null!=t?s.innerHTML=e+"<span>"+t+"</span>":s.innerHTML=e)})},saveToHistory=function(e,t){var s=userLogin+"."+e+".history",n=sessionStorage.getItem(s);n=n?JSON.parse(n):null,n||(n=[]),n.push(t),n.length>50&&n.splice(0,1),sessionStorage.setItem(s,JSON.stringify(n))},loadFromHistory=function(e){var t=userLogin+"."+e+".history",s=sessionStorage.getItem(t);s=s?JSON.parse(s):null,s&&s.forEach(function(e){appendMessage(e,e.fromUser!=userLogin)})},escapeHTML=function(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;")},onChatContentScroll=function(){myUnreadMessagesWhenCustomScroll>0&&chatContent.scrollTop==chatContent.scrollHeight-chatContent.offsetHeight&&(myUnreadMessagesWhenCustomScroll=0,setUnreadMessageCountForContact(currentMessageReceiver,null))};addListener(chatContent,"scroll",onChatContentScroll);var login=function(){null==sessionStorage.getItem("userName")||""==sessionStorage.getItem("userName")?document.getElementById("loginDialog").style.display="":initSocket(sessionStorage.getItem("userName"))},writeTo,minimize,expand;login();